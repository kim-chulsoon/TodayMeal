<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- jquery CDN -->
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <!-- googlrFont -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <!-- css -->
    <link rel="stylesheet" href="/static/css/users.css" />
    <title>회원 정보</title>
  </head>
  <body>
    <header>
      <a href="#" onClick="history.back()" class="mobile">
        <img src="/static/img/icons/Arrow - Left.png" alt="arrow" />
      </a>
      <p class="logo mobile">내정보</p>
      <!-- 웹 -->
      <a href="/" class="web logoA">
        <img src="/static/img/logo/b_logo.png" alt="logo" class="logoImg" />
        <span>오늘은 뭐 먹지?</span>
      </a>

      <div class="menu web">
        <!-- 로그인시  변경 herf 수정!!!!!! -->
        <% if(!true){ %>
        <a href="/users">내정보</a>
        <a href="/users/logout">로그아웃</a>
        <%}else{%>
        <a href="/users/login">로그인</a>
        <a href="/users/register">회원가입</a>
        <%} %>
      </div>
    </header>
    <main>
      <div class="con">
        <div class="userBox">
          <div class="web mobileTitle">
            <p>내 정보</p>
          </div>
          <!-- 프로필 박스1 -->
          <div class="userBox1">
            <!-- 프로필사진 이름 -->
            <div class="userPic">
              <img
                src="/static/img/demo/pro.png"
                alt="profileimage"
                class="profileImg"
              />
            </div>
            <div class="userP">
              <!-- 아래  =user.userId , name으로 -->
              <p class="userId">admin1234</p>
              <p class="userName">당근볶음</p>
            </div>
          </div>

          <!-- 프로필박스2 -->
          <div class="userBox2">
            <div class="box2">
              <span>정보수정</span>
              <a href="/users/edit">
                <img
                  src="/static/img/icons/arrow_right2.png"
                  alt="정보수정"
                  class="box2img"
                />
              </a>
            </div>
            <div class="box2">
              <span>즐겨찾기</span>
              <a href="/favorites">
                <img
                  src="/static/img/icons/arrow_right2.png"
                  alt="즐겨찾기"
                  class="box2img"
                />
              </a>
            </div>
            <div class="box2">
              <span>로그아웃</span>
              <a href="/users/logout">
                <img
                  src="/static/img/icons/arrow_right2.png"
                  alt="로그아웃"
                  class="box2img"
                  onclick="logout()"
                />
              </a>
            </div>
            <div class="box2">
              <span>회원탈퇴</span>
              <img
                src="/static/img/icons/arrow_right2.png"
                alt="회원탈퇴"
                class="box2img confirm"
                onclick="confirmClick()"
              />
            </div>
          </div>
        </div>
      </div>
    </main>
    <div class="mManu mobile">
      <div class="Menu">
        <div class="smallMenu">
          <a href="/">
            <img src="/static/img/icons/Home.png" alt="홈" />
          </a>
        </div>

        <div class="smallMenu">
          <a href="/favorites">
            <img src="/static/img/icons/Heart.png" alt="즐겨찾기" />
          </a>
        </div>

        <div class="smallMenu">
          <a href="/users">
            <img src="/static/img/icons/Profile.png" alt="프로필" />
          </a>
        </div>
      </div>
    </div>

    <footer class="web">
      <p>Copyright 2024. Team 2TheCode All rights reserved.</p>
    </footer>
  </body>
  <script>
    //토큰 받기
    $(document).ready(function () {
      const token = localStorage.getItem("authToken"); //토큰 가져오기

      console.log(token);

      if (!token) {
        alert("로그인이 필요합니다.");
        return;
      }

      //서버에 유저 정보 요청
      $ajax({
        type: "GET",
        url: "users/details", //회원 정보 라우터
        headers: {
          Authorization: `Bearer ${token}`, // 토큰을 헤더에 추가
        },
        success: function (res) {
          if (res.success) {
            // 아이디와 이름 프로필 이미지 채우기
            document.querySelector(".userId").innerText = res.user.userId;
            document.querySelector(".userPw").innerText = res.user.name;
            document.querySelector(".profileImg").src = res.user.profileImage;
          } else {
            alert("유저 정보를 불러올 수 없습니다. 다시 로그인해주세요.");
          }
        },
        error: function (err) {
          console.error("Error fetching user details:", err);
          alert("서버 오류가 발생했습니다.");
        },
      });
    });

    // 회원 탈퇴
    // 회원 탈퇴 함수
    function confirmClick() {
      if (confirm("회원을 탈퇴하시겠습니까?")) {
        const token = localStorage.getItem("authToken"); //토큰 가져오기

        if (!token) {
          alert("로그인이 필요합니다.");
          return;
        }

        // Ajax 요청
        $.ajax({
          type: "DELETE",
          url: "/users/delete", // 회원 탈퇴 라우트
          headers: {
            Authorization: `Bearer ${token}`, // 토큰
          },
          success: function (res) {
            if (res.success) {
              alert("회원 탈퇴가 완료되었습니다.");
              localStorage.removeItem("authToken"); // 로컬 스토리지 토큰 삭제
              document.location.href = "/"; // 홈으로
            } else {
              alert("회원 탈퇴 중 오류가 발생했습니다.");
            }
          },
          error: function (err) {
            console.error("회원 탈퇴 오류:", err);
            alert("서버 오류가 발생했습니다.");
          },
        });
      }
    }

    //로그아웃
    function logout() {
      localStorage.clear();
      document.location.href = "/";
    }
  </script>
</html>
